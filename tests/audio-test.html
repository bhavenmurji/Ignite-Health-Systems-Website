<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio System Test - Ignite Health Systems</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #0a0a0a;
            color: #ffffff;
        }
        .test-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #ff6b35;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #ff4500;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success { background: #2d5a2d; color: #90ee90; }
        .status.error { background: #5a2d2d; color: #ff6b6b; }
        .status.info { background: #2d4a5a; color: #87ceeb; }
        audio {
            width: 100%;
            margin: 10px 0;
        }
        .progress {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #ff6b35;
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <h1>üéµ Audio System Test Suite</h1>
    <p>Testing the new backing music implementation for Ignite Health Systems</p>
    
    <div class="test-section">
        <h2>üìÅ Audio File Availability Test</h2>
        <div id="file-test-results"></div>
        <button onclick="testAudioFiles()">Test Audio Files</button>
    </div>
    
    <div class="test-section">
        <h2>üéõÔ∏è Music Player Integration Test</h2>
        <div id="player-status" class="status info">Music Player: Not Loaded</div>
        <div class="test-controls">
            <button onclick="testMusicPlayer()">Test Music Player</button>
            <button onclick="testVolumeControl()">Test Volume</button>
            <button onclick="testMuteFunction()">Test Mute</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üéß Direct Audio Playback Test</h2>
        <audio id="direct-audio" controls preload="metadata">
            <source src="../assets/audio/new-backing-music-compressed.mp3" type="audio/mpeg">
            <source src="../assets/audio/new-backing-music.mp3" type="audio/mpeg">
            <source src="../assets/audio/new-backing-music.ogg" type="audio/ogg">
            Your browser does not support the audio element.
        </audio>
        <div class="progress">
            <div id="audio-progress" class="progress-bar" style="width: 0%"></div>
        </div>
        <div id="audio-info"></div>
    </div>
    
    <div class="test-section">
        <h2>üìä Performance Metrics</h2>
        <div id="performance-metrics">
            <p><strong>Page Load Time:</strong> <span id="load-time">Calculating...</span></p>
            <p><strong>Audio Load Time:</strong> <span id="audio-load-time">Pending...</span></p>
            <p><strong>First Audio Ready:</strong> <span id="first-ready">Pending...</span></p>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üîß Debug Information</h2>
        <div id="debug-info">
            <p><strong>User Agent:</strong> <span id="user-agent"></span></p>
            <p><strong>Audio Support:</strong> <span id="audio-support"></span></p>
            <p><strong>Autoplay Policy:</strong> <span id="autoplay-policy"></span></p>
        </div>
    </div>

    <script>
        // Performance tracking
        const startTime = performance.now();
        let audioLoadStart = null;
        let firstAudioReady = null;
        
        // Initialize debug info
        document.getElementById('user-agent').textContent = navigator.userAgent;
        
        // Test audio support
        function testAudioSupport() {
            const audio = document.createElement('audio');
            const formats = {
                mp3: audio.canPlayType('audio/mpeg'),
                ogg: audio.canPlayType('audio/ogg'),
                wav: audio.canPlayType('audio/wav'),
                webm: audio.canPlayType('audio/webm')
            };
            
            let supportText = [];
            for (const [format, support] of Object.entries(formats)) {
                if (support) {
                    supportText.push(`${format.toUpperCase()}: ${support}`);
                }
            }
            
            document.getElementById('audio-support').textContent = supportText.join(', ') || 'No audio support detected';
        }
        
        // Test autoplay policy
        async function testAutoplayPolicy() {
            try {
                const audio = new Audio();
                audio.volume = 0;
                audio.src = 'data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ4AAAAAAAAAAAABAAAAAAAAAA==';
                await audio.play();
                document.getElementById('autoplay-policy').textContent = 'Allowed';
                audio.pause();
            } catch (error) {
                document.getElementById('autoplay-policy').textContent = 'Blocked - ' + error.message;
            }
        }
        
        // Test individual audio files including MOV support
        async function testAudioFiles() {
            const files = [
                { src: '../assets/media/Backing music.mov', type: 'video/quicktime', format: 'MOV (Original)' },
                { src: '../assets/audio/new-backing-music-compressed.mp3', type: 'audio/mpeg', format: 'MP3 (Compressed)' },
                { src: '../assets/audio/new-backing-music.mp3', type: 'audio/mpeg', format: 'MP3 (Standard)' },
                { src: '../assets/audio/new-backing-music.ogg', type: 'audio/ogg', format: 'OGG' },
                { src: '../public/assets/audio/backing-music-compressed.mp3', type: 'audio/mpeg', format: 'MP3 (Public Compressed)' },
                { src: '../public/assets/audio/backing-music.mp3', type: 'audio/mpeg', format: 'MP3 (Public)' }
            ];
            
            const resultsDiv = document.getElementById('file-test-results');
            resultsDiv.innerHTML = '<p>Testing audio files including MOV support...</p>';
            
            const results = [];
            
            for (const file of files) {
                try {
                    // Test file availability
                    const response = await fetch(file.src, { method: 'HEAD' });
                    const size = response.headers.get('content-length');
                    const status = response.ok ? 'success' : 'error';
                    const sizeText = size ? `(${Math.round(size / 1024)}KB)` : '';
                    
                    // Test browser support
                    let browserSupport = '';
                    if (file.type.includes('video/quicktime')) {
                        const video = document.createElement('video');
                        const canPlay = video.canPlayType(file.type);
                        browserSupport = canPlay ? `‚úÖ Video support: ${canPlay}` : '‚ùå No video support';
                    } else {
                        const audio = document.createElement('audio');
                        const canPlay = audio.canPlayType(file.type);
                        browserSupport = canPlay ? `‚úÖ Audio support: ${canPlay}` : '‚ùå No audio support';
                    }
                    
                    results.push(`
                        <div class="status ${status}">
                            <strong>${file.format}:</strong> ${file.src}<br>
                            Status: ${response.status} ${response.statusText} ${sizeText}<br>
                            Browser: ${browserSupport}
                        </div>
                    `);
                } catch (error) {
                    results.push(`
                        <div class="status error">
                            <strong>${file.format}:</strong> ${file.src}<br>
                            Error: ${error.message}
                        </div>
                    `);
                }
            }
            
            resultsDiv.innerHTML = results.join('');
        }
        
        // Test optimized music player integration
        function testMusicPlayer() {
            const statusDiv = document.getElementById('player-status');
            
            if (window.OptimizedMusicPlayer) {
                statusDiv.innerHTML = `
                    <div class="status success">
                        ‚úÖ OptimizedMusicPlayer: Available<br>
                        üéµ MOV Support: ${window.OptimizedMusicPlayer.canPlayFormat ? window.OptimizedMusicPlayer.canPlayFormat('video/quicktime') ? 'Yes' : 'No' : 'Unknown'}<br>
                        üìä Analytics: ${window.OptimizedMusicPlayer.trackPerformance ? 'Enabled' : 'Disabled'}<br>
                        üîÑ Custom Looping: ${window.OptimizedMusicPlayer.setupCustomLooping ? 'Available' : 'Not Available'}
                    </div>
                `;
                
                // Try to get audio source and check for MOV
                if (window.OptimizedMusicPlayer.audio && window.OptimizedMusicPlayer.audio.src) {
                    const currentSrc = window.OptimizedMusicPlayer.audio.src;
                    const isMOV = currentSrc.toLowerCase().includes('.mov');
                    statusDiv.innerHTML += `
                        <div class="status info">
                            üìÅ Current Source: ${currentSrc}<br>
                            üé¨ Using MOV: ${isMOV ? 'Yes' : 'No'}<br>
                            üéõÔ∏è Element Type: ${window.OptimizedMusicPlayer.audio.tagName.toLowerCase()}
                        </div>
                    `;
                }
                
                // Test network detection
                if (window.OptimizedMusicPlayer.getNetworkInfo) {
                    const networkInfo = window.OptimizedMusicPlayer.getNetworkInfo();
                    statusDiv.innerHTML += `
                        <div class="status info">
                            üì∂ Network: ${networkInfo.effectiveType || 'Unknown'}<br>
                            üíæ Data Saver: ${networkInfo.saveData ? 'On' : 'Off'}<br>
                            ‚ö° Downlink: ${networkInfo.downlink || 'Unknown'} Mbps
                        </div>
                    `;
                }
            } else if (window.MusicPlayer) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        ‚ö†Ô∏è Old MusicPlayer detected - OptimizedMusicPlayer not loaded<br>
                        Please check script loading order
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå No Music Player found<br>
                        Neither OptimizedMusicPlayer nor MusicPlayer is available
                    </div>
                `;
            }
        }
        
        // Test volume control
        function testVolumeControl() {
            if (window.OptimizedMusicPlayer && window.OptimizedMusicPlayer.setVolume) {
                // Test volume at 50%
                window.OptimizedMusicPlayer.setVolume(0.5);
                alert('‚úÖ Volume set to 50%. Check the volume slider in the optimized player controls.');
                
                // Track performance
                if (window.OptimizedMusicPlayer.trackPerformance) {
                    window.OptimizedMusicPlayer.trackPerformance('volume_test', { volume: 0.5 });
                }
            } else if (window.MusicPlayer && window.MusicPlayer.setVolume) {
                window.MusicPlayer.setVolume(0.5);
                alert('‚ö†Ô∏è Using legacy MusicPlayer volume control');
            } else {
                alert('‚ùå Music Player volume control not available');
            }
        }
        
        // Test mute function
        function testMuteFunction() {
            if (window.OptimizedMusicPlayer && window.OptimizedMusicPlayer.toggleMute) {
                window.OptimizedMusicPlayer.toggleMute();
                alert('‚úÖ Mute toggled using OptimizedMusicPlayer. Check the mute button state.');
                
                // Track performance
                if (window.OptimizedMusicPlayer.trackPerformance) {
                    window.OptimizedMusicPlayer.trackPerformance('mute_test', { 
                        muted: window.OptimizedMusicPlayer.audio ? window.OptimizedMusicPlayer.audio.muted : null 
                    });
                }
            } else if (window.MusicPlayer && window.MusicPlayer.toggleMute) {
                window.MusicPlayer.toggleMute();
                alert('‚ö†Ô∏è Using legacy MusicPlayer mute function');
            } else {
                alert('‚ùå Music Player mute function not available');
            }
        }
        
        // Direct audio element tests
        const directAudio = document.getElementById('direct-audio');
        const progressBar = document.getElementById('audio-progress');
        const audioInfo = document.getElementById('audio-info');
        
        directAudio.addEventListener('loadstart', () => {
            audioLoadStart = performance.now();
            audioInfo.innerHTML = '<div class="status info">Loading audio...</div>';
        });
        
        directAudio.addEventListener('canplaythrough', () => {
            if (!firstAudioReady) {
                firstAudioReady = performance.now();
                document.getElementById('first-ready').textContent = `${Math.round(firstAudioReady - startTime)}ms`;
            }
            
            const loadTime = performance.now() - audioLoadStart;
            document.getElementById('audio-load-time').textContent = `${Math.round(loadTime)}ms`;
            
            audioInfo.innerHTML = `
                <div class="status success">Audio Ready</div>
                <p><strong>Duration:</strong> ${Math.round(directAudio.duration)}s</p>
                <p><strong>Current Source:</strong> ${directAudio.currentSrc}</p>
            `;
        });
        
        directAudio.addEventListener('error', (e) => {
            audioInfo.innerHTML = `<div class="status error">Audio Error: ${e.message || 'Unknown error'}</div>`;
        });
        
        directAudio.addEventListener('timeupdate', () => {
            if (directAudio.duration) {
                const progress = (directAudio.currentTime / directAudio.duration) * 100;
                progressBar.style.width = `${progress}%`;
            }
        });
        
        // Page load complete
        window.addEventListener('load', () => {
            const loadTime = performance.now() - startTime;
            document.getElementById('load-time').textContent = `${Math.round(loadTime)}ms`;
            
            // Initialize tests
            testAudioSupport();
            testAutoplayPolicy();
            
            // Auto-run file test
            setTimeout(testAudioFiles, 500);
            
            // Auto-test music player
            setTimeout(testMusicPlayer, 1000);
        });
        
        // Load the optimized music player script for testing
        const script = document.createElement('script');
        script.src = '../src/audio-optimization/optimized-music-player.js';
        script.async = true;
        script.onload = () => {
            console.log('‚úÖ OptimizedMusicPlayer script loaded');
            // Re-test music player after script loads
            setTimeout(testMusicPlayer, 500);
        };
        script.onerror = () => {
            console.error('‚ùå Failed to load OptimizedMusicPlayer script');
            // Fallback to old music player
            const fallbackScript = document.createElement('script');
            fallbackScript.src = '../js/music-player.js';
            fallbackScript.async = true;
            fallbackScript.onload = () => {
                console.log('‚ö†Ô∏è Loaded legacy MusicPlayer as fallback');
                setTimeout(testMusicPlayer, 500);
            };
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
    </script>
</body>
</html>